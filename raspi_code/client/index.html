<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スコア閲覧 (Web Bluetooth)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>スコア一覧 (Web Bluetooth)</h1>
  <button id="connectBtn">Bluetooth接続してスコア取得</button>
  <button id="dummyBtn">ダミーデータ表示</button>

  <div id="scoreTables" style="display: flex; gap: 32px;"></div>

  <script>
    const dummyBtn = document.getElementById('dummyBtn');
    // 組み込みダミーデータ
    const dummyData = {
      "20250813_150230": {
        "Aエリア": 12.5,
        "Bエリア": 8.3,
        "Cエリア": 15.0
      },
      "20250812_093000": {
        "Aエリア": 10.2,
        "Bエリア": 7.8,
        "Cエリア": 13.4
      }
    };
    const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
    const CHARACTERISTIC_UUID = 'abcdef01-1234-5678-1234-56789abcdef0';

    const connectBtn = document.getElementById('connectBtn');
  const scoreTablesDiv = document.getElementById('scoreTables');

    function formatTimestamp(ts) {
      // 例: 20250813_150230 → 2025/08/13 15:02:30
      const y = ts.slice(0,4);
      const m = ts.slice(4,6);
      const d = ts.slice(6,8);
      const h = ts.slice(9,11);
      const min = ts.slice(11,13);
      const s = ts.slice(13,15);
      return `${y}/${m}/${d} ${h}:${min}:${s}`;
    }

    let updateIntervalId = null;
    let characteristic = null;

    async function fetchAndUpdateScores() {
      try {
        const value = await characteristic.readValue();
        const decoder = new TextDecoder('utf-8');
        const jsonStr = decoder.decode(value);
        let scoreArr = [];
        try {
          scoreArr = JSON.parse(jsonStr);
        } catch (e) {
          console.error('JSON parse error', e);
          scoreArr = [];
        }

        // device_idごとにグループ化
        const grouped = {};
        for (const entry of scoreArr) {
          if (!grouped[entry.device_id]) grouped[entry.device_id] = [];
          grouped[entry.device_id].push(entry);
        }

        // 表をクリア
        scoreTablesDiv.innerHTML = '';

        // 各端末ごとに横並びで表を生成
        Object.entries(grouped).forEach(([device_id, entries]) => {
          const table = document.createElement('table');
          table.className = 'scoreTable';
          table.style.marginRight = '32px';
          table.innerHTML = `
            <caption style="font-weight:bold;">${device_id}</caption>
            <thead>
              <tr>
                <th>日付</th>
                <th>エリア</th>
                <th>スコア</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tbody = table.querySelector('tbody');
          // 日付降順
          entries.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
          for (const entry of entries) {
            let setTotal = 0;
            for (const area in entry.scores) {
              const score = Number(entry.scores[area]);
              setTotal += score;
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${formatTimestamp(entry.timestamp)}</td><td>${area}</td><td>${score.toFixed(2)}</td>`;
              tbody.appendChild(tr);
            }
            const trTotal = document.createElement('tr');
            trTotal.innerHTML = `<td>${formatTimestamp(entry.timestamp)}</td><td>セット合計</td><td>${setTotal.toFixed(2)}</td>`;
            tbody.appendChild(trTotal);
          }
          scoreTablesDiv.appendChild(table);
        });

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="2">エラー: ${err.message}</td></tr>`;
        totalCell.textContent = '0';
      }
    }

    connectBtn.addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        // 初回取得
        await fetchAndUpdateScores();

        // 5秒ごとに自動更新
        if (updateIntervalId) clearInterval(updateIntervalId);
        updateIntervalId = setInterval(fetchAndUpdateScores, 5000);

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="2">エラー: ${err.message}</td></tr>`;
        totalCell.textContent = '0';
      }
    });

      // ダミーデータ表示ボタン
      dummyBtn.addEventListener('click', async () => {
        try {
          // ダミーデータを複数端末分の配列形式で用意
          const dummyArr = [
            {
              device_id: 'raspi-001',
              timestamp: '20250813_150230',
              scores: { 'Aエリア': 12.5, 'Bエリア': 8.3, 'Cエリア': 15.0 }
            },
            {
              device_id: 'raspi-001',
              timestamp: '20250812_093000',
              scores: { 'Aエリア': 10.2, 'Bエリア': 7.8, 'Cエリア': 13.4 }
            },
            {
              device_id: 'raspi-002',
              timestamp: '20250813_150230',
              scores: { 'Aエリア': 9.1, 'Bエリア': 6.5, 'Cエリア': 11.0 }
            },
            {
              device_id: 'raspi-002',
              timestamp: '20250812_093000',
              scores: { 'Aエリア': 8.0, 'Bエリア': 5.8, 'Cエリア': 10.4 }
            }
          ];
          // device_idごとにグループ化
          const grouped = {};
          for (const entry of dummyArr) {
            if (!grouped[entry.device_id]) grouped[entry.device_id] = [];
            grouped[entry.device_id].push(entry);
          }
          scoreTablesDiv.innerHTML = '';
          Object.entries(grouped).forEach(([device_id, entries]) => {
            const table = document.createElement('table');
            table.className = 'scoreTable';
            table.style.marginRight = '32px';
            table.innerHTML = `
              <caption style="font-weight:bold;">${device_id}</caption>
              <thead>
                <tr>
                  <th>日付</th>
                  <th>エリア</th>
                  <th>スコア</th>
                </tr>
              </thead>
              <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            entries.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
            for (const entry of entries) {
              let setTotal = 0;
              for (const area in entry.scores) {
                const score = Number(entry.scores[area]);
                setTotal += score;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${formatTimestamp(entry.timestamp)}</td><td>${area}</td><td>${score.toFixed(2)}</td>`;
                tbody.appendChild(tr);
              }
              const trTotal = document.createElement('tr');
              trTotal.innerHTML = `<td>${formatTimestamp(entry.timestamp)}</td><td>セット合計</td><td>${setTotal.toFixed(2)}</td>`;
              tbody.appendChild(trTotal);
            }
            scoreTablesDiv.appendChild(table);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="3">エラー: ${err.message}</td></tr>`;
          totalCell.textContent = '0';
        }
      });
  </script>
</body>
</html>