<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スコアグラフ・CSV出力</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>スコアグラフ・CSV出力</h1>

  <div class="button-bar">
    <button id="backBtn" class="btn">← 戻る</button>
    <button id="toggleDummyBtn" class="btn">ダミーデータ表示</button>
    <button id="csvBtn" class="btn">CSVファイル作成</button>
  </div>

  <div class="chart-container">
    <canvas id="scoreChart" width="600" height="400"></canvas>
  </div>

  <script>
    let scoreArr = [];
    let dummyMode = false;
    let chart = null;

    const backBtn = document.getElementById('backBtn');
    const toggleDummyBtn = document.getElementById('toggleDummyBtn');
    const csvBtn = document.getElementById('csvBtn');

    // 戻るボタン
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // ダミーデータ切替
    toggleDummyBtn.addEventListener('click', () => {
      dummyMode = !dummyMode;
      if (dummyMode) {
        scoreArr = getDummyData();
      } else {
        renderRealOrEmpty();
      }
      updateToggleButton();
      drawChart(scoreArr);
    });

    // CSV作成
    csvBtn.addEventListener('click', () => {
      if (!Array.isArray(scoreArr) || scoreArr.length === 0) {
        alert('データがありません');
        return;
      }
      const csv = jsonToCsv(scoreArr);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'score_data.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // ページ表示（BFCache対応）
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) initializeFromStorage();
    });

    // 初期化
    function initializeFromStorage() {
      const jsonStr = localStorage.getItem('scoreArr');
      if (jsonStr) {
        try {
          const parsed = JSON.parse(jsonStr);
          if (Array.isArray(parsed) && parsed.length > 0) {
            scoreArr = parsed;
            dummyMode = false;
          } else {
            scoreArr = getDummyData();
            dummyMode = true;
          }
        } catch {
          scoreArr = getDummyData();
          dummyMode = true;
        }
      } else {
        scoreArr = getDummyData();
        dummyMode = true;
      }
      updateToggleButton();
      drawChart(scoreArr);
    }

    function updateToggleButton() {
      toggleDummyBtn.textContent = dummyMode ? 'ダミーデータ非表示' : 'ダミーデータ表示';
    }

    function renderRealOrEmpty() {
      const jsonStr = localStorage.getItem('scoreArr');
      if (jsonStr) {
        try {
          const parsed = JSON.parse(jsonStr);
          if (Array.isArray(parsed) && parsed.length > 0) {
            scoreArr = parsed;
            dummyMode = false;
            return;
          }
        } catch (e) {
          console.error('scoreArr の JSON 解析に失敗:', e);
        }
      }
      scoreArr = [];
      dummyMode = true;
    }

    function clearChart() {
      if (chart) {
        chart.destroy();
        chart = null;
      }
      const oldCanvas = document.getElementById('scoreChart');
      const parent = oldCanvas.parentNode;
      oldCanvas.remove();

      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'scoreChart';
      newCanvas.width = 600;
      newCanvas.height = 400;
      parent.appendChild(newCanvas);
      const ctx = newCanvas.getContext('2d');

      const dpr = window.devicePixelRatio || 1;
      ctx.save();
      ctx.scale(dpr, dpr);
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('データがありません（ダミーデータ表示でプレビュー可）', newCanvas.width / 2 / dpr, newCanvas.height / 2 / dpr);
      ctx.restore();
    }

    function getDummyData() {
      return [
        { device_id: 'raspi-001', timestamp: '20250813_150230', scores: { 'Aエリア': 12.5, 'Bエリア': 8.3, 'Cエリア': 15.0 } },
        { device_id: 'raspi-001', timestamp: '20250812_093000', scores: { 'Aエリア': 10.2, 'Bエリア': 7.8, 'Cエリア': 13.4 } },
        { device_id: 'raspi-002', timestamp: '20250813_150230', scores: { 'Aエリア': 9.1, 'Bエリア': 6.5, 'Cエリア': 11.0 } },
        { device_id: 'raspi-002', timestamp: '20250812_093000', scores: { 'Aエリア': 8.0, 'Bエリア': 5.8, 'Cエリア': 10.4 } }
      ];
    }

    function jsonToCsv(arr) {
      const rows = ['device_id,timestamp,area,score'];
      arr.forEach(entry => {
        Object.entries(entry.scores).forEach(([area, score]) => {
          const safeDevice = `"${entry.device_id.replace(/"/g, '""')}"`;
          const safeTime = `"${entry.timestamp.replace(/"/g, '""')}"`;
          const safeArea = `"${area.replace(/"/g, '""')}"`;
          rows.push(`${safeDevice},${safeTime},${safeArea},${score}`);
        });
      });
      return rows.join('\n');
    }

    function drawChart(arr) {
      if (!arr || arr.length === 0) {
        clearChart();
        return;
      }

      const ctx = document.getElementById('scoreChart').getContext('2d');
      const deviceAreaScores = {};
      arr.forEach(entry => {
        if (!deviceAreaScores[entry.device_id]) deviceAreaScores[entry.device_id] = {};
        Object.entries(entry.scores).forEach(([area, score]) => {
          if (!deviceAreaScores[entry.device_id][area]) deviceAreaScores[entry.device_id][area] = 0;
          deviceAreaScores[entry.device_id][area] += Number(score);
        });
      });

      const devices = Object.keys(deviceAreaScores);
      const areas = Array.from(new Set(arr.flatMap(e => Object.keys(e.scores))));

      const datasets = areas.map((area, idx) => ({
        label: area,
        data: devices.map(dev => deviceAreaScores[dev][area] || 0),
        backgroundColor: `hsl(${(idx * 60) % 360}, 70%, 60%)`
      }));

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: devices, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'デバイスごとのエリア別合計スコア' }
          }
        }
      });
    }

    initializeFromStorage();
  </script>
</body>
</html>