<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スコアグラフ・CSV出力</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .chart-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      justify-items: center;
      align-items: start;
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
    }
    .chart-box {
      width: 480px;
      min-width: 320px;
      max-width: 100%;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      width: 420px !important;
      height: 280px !important;
      max-width: 100%;
      margin: 0 auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

  <h1>スコアグラフ・CSV出力</h1>

  <div class="button-bar">
  <button id="backBtn" class="btn">← 戻る</button>
  <button id="toggleDummyBtn" class="btn">ダミーデータ表示</button>
  <button id="csvBtn" class="btn">CSVファイル作成</button>
  </div>

  <div class="chart-container">
    <div class="chart-box">
  <canvas id="areaSumChart" width="420" height="280"></canvas>
      <div style="text-align:center; font-size:1em; margin-top:4px;">エリア別合計</div>
    </div>
    <div class="chart-box">
  <canvas id="setSumChart" width="420" height="280"></canvas>
      <div style="text-align:center; font-size:1em; margin-top:4px;">セット別合計</div>
    </div>
    <div class="chart-box">
  <canvas id="areaTrendChart" width="420" height="280"></canvas>
      <div style="text-align:center; font-size:1em; margin-top:4px;">エリア別推移</div>
    </div>
    <div class="chart-box">
  <canvas id="deviceSetTrendChart" width="420" height="280"></canvas>
      <div style="text-align:center; font-size:1em; margin-top:4px;">デバイスごとセット合計推移</div>
    </div>
  </div>

  <script>
  let scoreArr = [];
  let dummyMode = false;
  let chartObjs = {};

  const backBtn = document.getElementById('backBtn');
  const toggleDummyBtn = document.getElementById('toggleDummyBtn');
  const csvBtn = document.getElementById('csvBtn');
  const chartType = document.getElementById('chartType');

    // 戻るボタン
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // ダミーデータ切替
    toggleDummyBtn.addEventListener('click', () => {
      dummyMode = !dummyMode;
      if (dummyMode) {
        scoreArr = getDummyData();
        drawAllCharts(scoreArr);
      } else {
        renderRealOrEmpty();
      }
      updateToggleButton();
    });

    // CSV作成
    csvBtn.addEventListener('click', () => {
      if (!Array.isArray(scoreArr) || scoreArr.length === 0) {
        alert('データがありません');
        return;
      }
      const csv = jsonToCsv(scoreArr);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'score_data.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // ページ表示（BFCache対応）
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) initializeFromStorage();
    });

    // 初期化
    function initializeFromStorage() {
      const jsonStr = localStorage.getItem('scoreArr');
      if (jsonStr) {
        try {
          const parsed = JSON.parse(jsonStr);
          if (Array.isArray(parsed) && parsed.length > 0) {
            scoreArr = parsed;
            dummyMode = false;
          } else {
            scoreArr = getDummyData();
            dummyMode = true;
          }
        } catch {
          scoreArr = getDummyData();
          dummyMode = true;
        }
      } else {
        scoreArr = getDummyData();
        dummyMode = true;
      }
      updateToggleButton();
      drawAllCharts(scoreArr);
    }

    function updateToggleButton() {
      toggleDummyBtn.textContent = dummyMode ? 'ダミーデータ非表示' : 'ダミーデータ表示';
    }

    function renderRealOrEmpty() {
      const jsonStr = localStorage.getItem('scoreArr');
      if (jsonStr) {
        try {
          const parsed = JSON.parse(jsonStr);
          if (Array.isArray(parsed) && parsed.length > 0) {
            scoreArr = parsed;
            dummyMode = false;
            drawAllCharts(scoreArr);
            return;
          }
        } catch (e) {
          console.error('scoreArr の JSON 解析に失敗:', e);
        }
      }
      scoreArr = [];
      dummyMode = true;
      drawAllCharts(scoreArr);
    }

    function clearChart() {
      if (chart) {
        chart.destroy();
        chart = null;
      }
      const oldCanvas = document.getElementById('scoreChart');
      const parent = oldCanvas.parentNode;
      oldCanvas.remove();

      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'scoreChart';
      newCanvas.width = 600;
      newCanvas.height = 400;
      parent.appendChild(newCanvas);
      const ctx = newCanvas.getContext('2d');

      const dpr = window.devicePixelRatio || 1;
      ctx.save();
      ctx.scale(dpr, dpr);
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('データがありません（ダミーデータ表示でプレビュー可）', newCanvas.width / 2 / dpr, newCanvas.height / 2 / dpr);
      ctx.restore();
    }

    function getDummyData() {
      return [
        { device_id: 'raspi-001', timestamp: '20250813_150230', scores: { 'Aエリア': 12.5, 'Bエリア': 8.3, 'Cエリア': 15.0 } },
        { device_id: 'raspi-001', timestamp: '20250812_093000', scores: { 'Aエリア': 10.2, 'Bエリア': 7.8, 'Cエリア': 13.4 } },
        { device_id: 'raspi-001', timestamp: '20250811_101500', scores: { 'Aエリア': 11.8, 'Bエリア': 9.1, 'Cエリア': 14.2 } },
        { device_id: 'raspi-001', timestamp: '20250810_084500', scores: { 'Aエリア': 13.0, 'Bエリア': 8.7, 'Cエリア': 15.5 } },

        { device_id: 'raspi-002', timestamp: '20250813_150230', scores: { 'Aエリア': 9.1, 'Bエリア': 6.5, 'Cエリア': 11.0 } },
        { device_id: 'raspi-002', timestamp: '20250812_093000', scores: { 'Aエリア': 8.0, 'Bエリア': 5.8, 'Cエリア': 10.4 } },
        { device_id: 'raspi-002', timestamp: '20250811_101500', scores: { 'Aエリア': 10.5, 'Bエリア': 7.2, 'Cエリア': 12.3 } },
        { device_id: 'raspi-002', timestamp: '20250810_084500', scores: { 'Aエリア': 9.8, 'Bエリア': 6.9, 'Cエリア': 11.7 } },

        { device_id: 'raspi-003', timestamp: '20250813_150230', scores: { 'Aエリア': 14.2, 'Bエリア': 10.1, 'Cエリア': 16.3 } },
        { device_id: 'raspi-003', timestamp: '20250812_093000', scores: { 'Aエリア': 13.0, 'Bエリア': 9.5, 'Cエリア': 15.8 } },
        { device_id: 'raspi-003', timestamp: '20250811_101500', scores: { 'Aエリア': 12.7, 'Bエリア': 10.3, 'Cエリア': 16.0 } },
        { device_id: 'raspi-003', timestamp: '20250810_084500', scores: { 'Aエリア': 13.5, 'Bエリア': 9.8, 'Cエリア': 15.9 } },

        { device_id: 'raspi-004', timestamp: '20250813_150230', scores: { 'Aエリア': 7.9, 'Bエリア': 5.2, 'Cエリア': 9.4 } },
        { device_id: 'raspi-004', timestamp: '20250812_093000', scores: { 'Aエリア': 8.3, 'Bエリア': 6.1, 'Cエリア': 10.2 } },
        { device_id: 'raspi-004', timestamp: '20250811_101500', scores: { 'Aエリア': 7.5, 'Bエリア': 5.7, 'Cエリア': 9.8 } },
        { device_id: 'raspi-004', timestamp: '20250810_084500', scores: { 'Aエリア': 8.0, 'Bエリア': 6.3, 'Cエリア': 10.5 } }
      ];
    }

    function jsonToCsv(arr) {
      const rows = ['device_id,timestamp,area,score'];
      arr.forEach(entry => {
        Object.entries(entry.scores).forEach(([area, score]) => {
          const safeDevice = `"${entry.device_id.replace(/"/g, '""')}"`;
          const safeTime = `"${entry.timestamp.replace(/"/g, '""')}"`;
          const safeArea = `"${area.replace(/"/g, '""')}"`;
          rows.push(`${safeDevice},${safeTime},${safeArea},${score}`);
        });
      });
      return rows.join('\n');
    }

    // 日付フォーマット関数
    function formatTimestamp(ts) {
      // 例: "20250813_150230" → "2025/08/13 15:02:30"
      if (!ts) return '';
      const m = ts.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
      if (!m) return ts;
      return `${m[1]}/${m[2]}/${m[3]} ${m[4]}:${m[5]}:${m[6]}`;
    }

    // 複数グラフ描画関数群
    function drawAllCharts(arr) {
      drawAreaSumChart(arr);
      drawSetSumChart(arr);
      drawAreaTrendChart(arr);
      drawDeviceSetTrendChart(arr);
    }

    function destroyChart(id) {
      if (chartObjs[id]) {
        chartObjs[id].destroy();
        chartObjs[id] = null;
      }
    }

    function drawAreaSumChart(arr) {
      const ctx = document.getElementById('areaSumChart').getContext('2d');
      destroyChart('areaSumChart');
      if (!arr || arr.length === 0) return;
      const deviceAreaScores = {};
      arr.forEach(entry => {
        if (!deviceAreaScores[entry.device_id]) deviceAreaScores[entry.device_id] = {};
        Object.entries(entry.scores).forEach(([area, score]) => {
          if (!deviceAreaScores[entry.device_id][area]) deviceAreaScores[entry.device_id][area] = 0;
          deviceAreaScores[entry.device_id][area] += Number(score);
        });
      });
      const devices = Object.keys(deviceAreaScores);
      const areas = Array.from(new Set(arr.flatMap(e => Object.keys(e.scores))));
      const datasets = areas.map((area, idx) => ({
        label: area,
        data: devices.map(dev => deviceAreaScores[dev][area] || 0),
        backgroundColor: `hsl(${(idx * 60) % 360}, 70%, 60%)`
      }));
      chartObjs['areaSumChart'] = new Chart(ctx, {
        type: 'bar',
        data: { labels: devices, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: false }
          }
        }
      });
    }

    function drawSetSumChart(arr) {
      const ctx = document.getElementById('setSumChart').getContext('2d');
      destroyChart('setSumChart');
      if (!arr || arr.length === 0) return;
      const labels = arr.map(e => formatTimestamp(e.timestamp));
      const data = arr.map(e => Object.values(e.scores).reduce((a, b) => a + Number(b), 0));
      chartObjs['setSumChart'] = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'セット合計スコア',
            data,
            borderColor: 'blue',
            backgroundColor: 'rgba(0,0,255,0.2)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false }
          }
        }
      });
    }

    function drawAreaTrendChart(arr) {
      const ctx = document.getElementById('areaTrendChart').getContext('2d');
      destroyChart('areaTrendChart');
      if (!arr || arr.length === 0) return;
      const areas = Array.from(new Set(arr.flatMap(e => Object.keys(e.scores))));
      const labels = arr.map(e => formatTimestamp(e.timestamp));
      const datasets = areas.map((area, idx) => ({
        label: area,
        data: arr.map(e => Number(e.scores[area] || 0)),
        borderColor: `hsl(${(idx * 60) % 360}, 70%, 60%)`,
        backgroundColor: `hsla(${(idx * 60) % 360}, 70%, 60%, 0.2)`,
        fill: false
      }));
      chartObjs['areaTrendChart'] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: false }
          }
        }
      });
    }

    function drawDeviceSetTrendChart(arr) {
      const ctx = document.getElementById('deviceSetTrendChart').getContext('2d');
      destroyChart('deviceSetTrendChart');
      if (!arr || arr.length === 0) return;
      const devices = Array.from(new Set(arr.map(e => e.device_id)));
      const labels = arr.map(e => formatTimestamp(e.timestamp));
      const datasets = devices.map((dev, idx) => ({
        label: dev,
        data: arr.map(e => e.device_id === dev ? Object.values(e.scores).reduce((a, b) => a + Number(b), 0) : null),
        borderColor: `hsl(${(idx * 60) % 360}, 70%, 60%)`,
        backgroundColor: `hsla(${(idx * 60) % 360}, 70%, 60%, 0.2)`,
        fill: false
      }));
      chartObjs['deviceSetTrendChart'] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: false }
          }
        }
      });
    }

    // 初期化時に複数グラフ描画
    initializeFromStorage();
  </script>
</body>
</html>